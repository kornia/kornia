name: pytest
description: "Run CPU tests with pytest"

inputs:
  python-version:
    description: "Python version to use"
    required: false
    default: "3.12"
  pytorch-version:
    description: "PyTorch version to use"
    required: false
    default: 2.5.1
  os:
    description: "Operating system to run on"
    required: false
    default: ubuntu-latest
  pytorch-dtype:
    description: "PyTorch data type for testing"
    required: false
    default: float32
  pytorch-device:
    description: "PyTorch device for testing"
    required: false
    default: cpu
  pytest-extra:
    description: "Extra pytest arguments"
    required: false
    default: --timeout=30 -k "not test_dynamo"
  ref:
    description: "Git reference to checkout"
    default: ${{ github.sha }}
  huggingface-token:
    description: "HuggingFace Hub API token for model downloads"
    required: false
    default: ""


runs:
  using: "composite"
  steps:
    - name: Setting environment on ${{ inputs.os }} with python ${{ inputs.python-version }} and pytorch ${{ inputs.pytorch-version }}
      uses: ./.github/actions/env #@v1.13.0
      with:
        python-version: ${{ inputs.python-version }}
        pytorch-version: ${{ inputs.pytorch-version }}
        ref: ${{ inputs.ref }}

    - name: Run CPU tests ${{ inputs.pytorch-dtype }}
      shell: bash -l {0}
      env:
        HF_TOKEN: ${{ inputs.huggingface-token }}
      run: |
        pytest -v ./tests/ --device=${{ inputs.pytorch-device }} --dtype=${{ inputs.pytorch-dtype }} ${{ inputs.pytest-extra }}
