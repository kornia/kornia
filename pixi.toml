[workspace]
name = "kornia"
description = "Open Source Differentiable Computer Vision Library for PyTorch"
authors = ["Edgar Riba <edgar@kornia.org>"]
channels = ["conda-forge"]
platforms = ["linux-64", "linux-aarch64", "osx-arm64", "osx-64", "win-64"]

# ------------------------------------------------------------------------------
# Base: Python + uv
# ------------------------------------------------------------------------------

[dependencies]
python = ">=3.10,<3.13"
uv = "*"
tombi = "*"

# ------------------------------------------------------------------------------
# Environments
# ------------------------------------------------------------------------------

[environments]
# Default uses CPU PyTorch with Python 3.11 (best compatibility)
default = { features = ["cpu", "py311"], solve-group = "default" }
# CUDA environment for GPU development
cuda = { features = ["cuda", "py311"], solve-group = "cuda" }
# CI environments - CPU PyTorch with specific Python versions
py310 = { features = ["cpu", "py310"], solve-group = "py310" }
py311 = { features = ["cpu", "py311"], solve-group = "py311" }
py312 = { features = ["cpu", "py312"], solve-group = "py312" }

# ------------------------------------------------------------------------------
# Tasks (shared across environments)
# ------------------------------------------------------------------------------

[tasks]
# Tests - use env vars (KORNIA_TEST_DEVICE, KORNIA_TEST_DTYPE, KORNIA_TEST_RUNSLOW)
test = { cmd = "uv run pytest -v tests/", description = "Run tests (configure via KORNIA_TEST_* env vars)" }
test-f32 = { cmd = "uv run pytest -v tests/", env = { KORNIA_TEST_DTYPE = "float32" } }
test-f64 = { cmd = "uv run pytest -v tests/", env = { KORNIA_TEST_DTYPE = "float64" } }
test-slow = { cmd = "uv run pytest -v tests/", env = { KORNIA_TEST_RUNSLOW = "true" } }
test-quick = { cmd = "uv run pytest -v -m 'not (jit or grad or nn)' tests/" }
# Quality
lint = { cmd = "uv run pre-commit run ruff --all-files" }
typecheck = { cmd = "uvx ty check" }
doctest = { cmd = "uv run pytest -v --doctest-modules kornia/" }
toml-fmt = { cmd = "tombi format", description = "Format TOML files" }
toml-fmt-check = { cmd = "tombi format --check", description = "Check TOML formatting" }
# Docs
build-docs = { cmd = "uv run sphinx-build -W -b html docs/source docs/build/html" }
# Utility
clean = { cmd = "find . -type f -name '*.pyc' -delete && find . -type d -name '__pycache__' -delete && rm -rf .venv" }

# ------------------------------------------------------------------------------
# Feature: CPU (PyTorch CPU wheels) - default for CI and non-GPU machines
# ------------------------------------------------------------------------------

[feature.cpu.tasks]
install = { cmd = "uv sync --extra dev --python $(which python)", description = "Install dev dependencies (CPU PyTorch)" }
install-docs = { cmd = "uv sync --extra dev --extra docs --python $(which python)", description = "Install dev + docs (CPU PyTorch)" }

# ------------------------------------------------------------------------------
# Feature: CUDA (PyTorch CUDA wheels) - for local GPU development
# Uses .venv-cuda; requires reinstall because pyproject.toml locks torch to CPU
# (uv doesn't support per-environment sources)
# ------------------------------------------------------------------------------

[feature.cuda.tasks]
install = { cmd = "uv sync --extra dev --extra x --python $(which python) && uv pip install --reinstall torch torchvision --index pytorch-cu121 --python .venv-cuda", env = { UV_PROJECT_ENVIRONMENT = ".venv-cuda" }, description = "Install dev dependencies (CUDA PyTorch)" }
install-docs = { cmd = "uv sync --extra dev --extra docs --extra x --python $(which python) && uv pip install --reinstall torch torchvision --index pytorch-cu121 --python .venv-cuda", env = { UV_PROJECT_ENVIRONMENT = ".venv-cuda" }, description = "Install dev + docs (CUDA PyTorch)" }
# CUDA test tasks
test-cuda = { cmd = ".venv-cuda/bin/pytest -v tests/", env = { KORNIA_TEST_DEVICE = "cuda" }, description = "Run tests on CUDA" }
test-cuda-f32 = { cmd = ".venv-cuda/bin/pytest -v tests/", env = { KORNIA_TEST_DEVICE = "cuda", KORNIA_TEST_DTYPE = "float32" } }
test-cuda-f64 = { cmd = ".venv-cuda/bin/pytest -v tests/", env = { KORNIA_TEST_DEVICE = "cuda", KORNIA_TEST_DTYPE = "float64" } }

# ------------------------------------------------------------------------------
# Python version features (for CI matrix)
# ------------------------------------------------------------------------------

[feature.py310.dependencies]
python = "3.10.*"

[feature.py311.dependencies]
python = "3.11.*"

[feature.py312.dependencies]
python = "3.12.*"
