version: 2.1

commands:
  common:
    steps:
      - checkout
      - run:
          name: activate environment
          command: source path.bash.inc
      - run:
          name: install package
          command: make install
      - run:
          name: lint check
          command: make lint
      - run:
          name: static check
          command: make mypy
      - run:
          name: unit tests
          command: make test-cpu
          no_output_timeout: 45m
      - run:
          name: send coverage
          when: on_success
          command: bash <(curl -s https://codecov.io/bash)
  docs:
    steps:
      - run:
          name: docs
          command: make build-docs
  install_dep_torch_151:
    steps:
      - checkout
      - run:
          name: install dependencies with torch 1.5.1
          command: |
            echo "\$conda_bin install pytorch==1.5.1 -c pytorch" >> ./setup_dev_env.sh
            ./setup_dev_env.sh
  install_dep_torch_160:
    steps:
      - checkout
      - run:
          name: install dependencies with torch 1.6.0
          command: |
            echo "\$conda_bin install pytorch==1.6.0 -c pytorch" >> ./setup_dev_env.sh
            ./setup_dev_env.sh


jobs:
  python_36_torch151:
    docker:
      - image: circleci/python:3.6.5
        environment:
          - PYTHON_VERSION: "3.6"
    steps:
      - install_dep_torch_151
      - common
  python_36_torch160:
    docker:
      - image: circleci/python:3.6.5
        environment:
          - PYTHON_VERSION: "3.6"
    steps:
      - install_dep_torch_160
      - common
      - docs

  python_37_torch151:
    docker:
      - image: circleci/python:3.7.3
        environment:
          - PYTHON_VERSION: "3.7"
    steps:
      - install_dep_torch_151
      - common
  python_37_torch160:
    docker:
      - image: circleci/python:3.7.3
        environment:
          - PYTHON_VERSION: "3.7"
    steps:
      - install_dep_torch_160
      - common

  python_38_torch151:
    docker:
      - image: circleci/python:3.8.0
        environment:
          - PYTHON_VERSION: "3.8"
    steps:
      - install_dep_torch_151
      - common
  python_38_torch160:
    docker:
      - image: circleci/python:3.8.0
        environment:
          - PYTHON_VERSION: "3.8"
    steps:
      - install_dep_torch_160
      - common

workflows:
  version: 2
  test:
    jobs:
      - python_36_torch151
      - python_36_torch160
      - python_37_torch151
      - python_37_torch160
      - python_38_torch151
      - python_38_torch160
